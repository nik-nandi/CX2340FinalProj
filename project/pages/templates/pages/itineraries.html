{% extends 'pages/base.html' %}
{% load static %}

{% block content %}
<div class="itinerary-container">
    <div class="itinerary-header">
        <h2>My Itinerary</h2>
        <div class="trip-area-selector">
            <label for="trip-area">Trip Area:</label>
            <select id="trip-area" onchange="location.href='?trip_area=' + this.value">
                {% for area in trip_areas %}
                    <option value="{{ area.id }}" {% if selected_trip_area.id == area.id %}selected{% endif %}>
                        {{ area.name }}
                    </option>
                {% endfor %}
            </select>
            
            <a href="{% url 'map_ui' %}" class="btn">Create Trip Area</a>
            <a href="{% url 'profile' %}" class="btn">Back to Profile</a>
        </div>
    </div>
    
    {% if selected_trip_area %}
    <div class="itinerary-content">
        <div class="itinerary-sidebar">
            <div class="itinerary-section">
                <h3>Your Itinerary</h3>
                {% if itinerary_items %}
                <ul id="itinerary-list" class="itinerary-items">
                    {% for item in itinerary_items %}
                    <li id="itinerary-item-{{ item.id }}" data-id="{{ item.id }}" class="itinerary-item">
                        <div class="item-content">
                            <h4>{{ item.name }}</h4>
                            <p>{{ item.address }}</p>
                            <div class="item-actions">
                                <button class="btn-small view-on-map" data-lat="{{ item.latitude }}" data-lng="{{ item.longitude }}">View on Map</button>
                                <button class="btn-small remove-item" data-id="{{ item.id }}">Remove</button>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="empty-message">No attractions added to your itinerary yet. Search below to find attractions.</p>
                {% endif %}
            </div>
            
            <div class="search-section">
                <h3>Find Attractions</h3>
                <div class="attraction-filters">
                    <button class="filter-btn active" data-type="tourist_attraction">Attractions</button>
                    <button class="filter-btn" data-type="restaurant">Food</button>
                    <button class="filter-btn" data-type="lodging">Lodging</button>
                </div>
                <div id="search-results" class="search-results">
                    <p class="loading-message" style="display: none;">Loading attractions...</p>
                    <div class="results-container"></div>
                </div>
            </div>
        </div>
        
        <div class="itinerary-map-container">
            <div id="itinerary-map" style="height: 600px; width: 100%;"></div>
        </div>
    </div>
    {% else %}
    <div class="no-trip-area">
        <p>You haven't created any trip areas yet. Create one to start planning your itinerary.</p>
        <a href="{% url 'map_ui' %}" class="btn">Create Trip Area</a>
    </div>
    {% endif %}
</div>

<script>
let map;
let markers = [];
let infoWindow;
let selectedTripArea = {% if selected_trip_area %}{{ selected_trip_area.id }}{% else %}null{% endif %};

function initMap() {
    if (!selectedTripArea) return;

    // Initialize map
    {% if selected_trip_area %}
    const tripAreaCenter = { lat: {{ selected_trip_area.latitude }}, lng: {{ selected_trip_area.longitude }} };
    const tripAreaRadius = {{ selected_trip_area.radius }} * 1000; // Convert km to meters
    {% else %}
    const tripAreaCenter = { lat: 33.7490, lng: -84.3880 }; // Default to Atlanta if no trip area
    const tripAreaRadius = 10000; // Default 10km radius
    {% endif %}
    
    map = new google.maps.Map(document.getElementById("itinerary-map"), {
        zoom: 13,
        center: tripAreaCenter
    });
    
    infoWindow = new google.maps.InfoWindow();
    
    // Draw circle for trip area radius
    const tripAreaCircle = new google.maps.Circle({
        strokeColor: "#FF0000",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#FF0000",
        fillOpacity: 0.1,
        map: map,
        center: tripAreaCenter,
        radius: tripAreaRadius
    });
    
    // Add existing itinerary items to map
    {% for item in itinerary_items %}
    addMarkerToMap({
        position: {lat: {{ item.latitude }}, lng: {{ item.longitude }}},
        title: "{{ item.name }}",
        address: "{{ item.address }}",
        id: {{ item.id }},
        isItineraryItem: true
    });
    {% endfor %}
    
    // Perform initial search for attractions
    searchAttractions('tourist_attraction');
    
    // Set up event handlers for filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Perform search with selected filter
            searchAttractions(this.dataset.type);
        });
    });
    
    // Set up event handlers for itinerary list items
    setupItineraryItemHandlers();
}

function searchAttractions(type) {
    if (!selectedTripArea) return;
    
    const resultsContainer = document.querySelector('#search-results .results-container');
    const loadingMessage = document.querySelector('#search-results .loading-message');
    
    // Show loading message
    resultsContainer.innerHTML = '';
    loadingMessage.style.display = 'block';
    
    // Clear previous attraction markers (keep itinerary markers)
    markers.forEach(marker => {
        if (!marker.isItineraryItem) {
            marker.setMap(null);
        }
    });
    markers = markers.filter(marker => marker.isItineraryItem);
    
    // Make API request
    fetch(`/api/attractions/search/?trip_area_id=${selectedTripArea}&type=${type}`)
        .then(response => response.json())
        .then(data => {
            loadingMessage.style.display = 'none';
            
            if (data.error) {
                resultsContainer.innerHTML = `<p class="error-message">Error: ${data.error}</p>`;
                return;
            }
            
            if (!data.results || data.results.length === 0) {
                resultsContainer.innerHTML = `<p>No ${type.replace('_', ' ')}s found in this area.</p>`;
                return;
            }
            
            // Display results
            let resultsHTML = '';
            data.results.forEach(place => {
                resultsHTML += `
                <div class="search-result">
                    <h4>${place.name}</h4>
                    <p>${place.vicinity || ''}</p>
                    <div class="search-result-actions">
                        <button class="btn-small view-attraction" 
                            data-lat="${place.geometry.location.lat}" 
                            data-lng="${place.geometry.location.lng}">
                            View on Map
                        </button>
                        <button class="btn-small add-to-itinerary" 
                            data-place='${JSON.stringify(place).replace(/'/g, "&#39;")}'>
                            Add to Itinerary
                        </button>
                    </div>
                </div>
                `;
                
                // Add marker to map
                addMarkerToMap({
                    position: {
                        lat: place.geometry.location.lat,
                        lng: place.geometry.location.lng
                    },
                    title: place.name,
                    address: place.vicinity || '',
                    place_id: place.place_id,
                    isItineraryItem: false,
                    place: place
                });
            });
            
            resultsContainer.innerHTML = resultsHTML;
            
            // Set up event handlers for results
            setupSearchResultHandlers();
        })
        .catch(error => {
            loadingMessage.style.display = 'none';
            resultsContainer.innerHTML = `<p class="error-message">Error: ${error.message}</p>`;
        });
}

function addMarkerToMap(options) {
    // Define blue icon with HTTPS URL for security
    const blueIcon = {
        url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        scaledSize: new google.maps.Size(32, 32)
    };
    
    const redIcon = {
        url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
        scaledSize: new google.maps.Size(32, 32)
    };

    const marker = new google.maps.Marker({
        position: options.position,
        map: map,
        title: options.title,
        animation: options.isItineraryItem ? google.maps.Animation.DROP : null,
        icon: options.isItineraryItem ? blueIcon : redIcon
    });
    
    marker.isItineraryItem = options.isItineraryItem;
    if (options.id) marker.id = options.id;
    if (options.place_id) marker.place_id = options.place_id;
    
    marker.addListener("click", () => {
        const content = `
            <div class="info-window">
                <h4>${options.title}</h4>
                <p>${options.address}</p>
                ${!options.isItineraryItem && options.place ? 
                `<button id="add-from-map-${options.place_id}" class="btn-small">Add to Itinerary</button>` 
                : ''}
            </div>
        `;
        
        infoWindow.setContent(content);
        infoWindow.open(map, marker);
        
        // Add event listener after info window is opened
        if (!options.isItineraryItem && options.place) {
            setTimeout(() => {
                const btn = document.getElementById(`add-from-map-${options.place_id}`);
                if (btn) {
                    btn.addEventListener('click', () => {
                        addToItinerary(options.place);
                    });
                }
            }, 100);
        }
    });
    
    markers.push(marker);
    return marker;
}

function setupSearchResultHandlers() {
    // View on map buttons
    document.querySelectorAll('.search-result .view-attraction').forEach(btn => {
        btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            
            map.setCenter({lat, lng});
            map.setZoom(16);
            
            // Find and activate the corresponding marker
            const marker = markers.find(m => 
                m.getPosition().lat() === lat && 
                m.getPosition().lng() === lng
            );
            
            if (marker) {
                google.maps.event.trigger(marker, 'click');
            }
        });
    });
    
    // Add to itinerary buttons
    document.querySelectorAll('.search-result .add-to-itinerary').forEach(btn => {
        btn.addEventListener('click', function() {
            const place = JSON.parse(this.dataset.place);
            addToItinerary(place);
        });
    });
}

function setupItineraryItemHandlers() {
    // View on map buttons
    document.querySelectorAll('.itinerary-item .view-on-map').forEach(btn => {
        btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            
            map.setCenter({lat, lng});
            map.setZoom(16);
            
            // Find and activate the corresponding marker
            const marker = markers.find(m => 
                m.id === parseInt(this.closest('.itinerary-item').dataset.id)
            );
            
            if (marker) {
                google.maps.event.trigger(marker, 'click');
            }
        });
    });
    
    // Remove buttons - use event delegation instead of direct binding
    document.querySelectorAll('.itinerary-item .remove-item').forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.dataset.id;
            removeFromItinerary(itemId, this.closest('.itinerary-item'));
        });
    });
}

function addToItinerary(place) {
    fetch('/api/itinerary/add/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            trip_area_id: selectedTripArea,
            place: place
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Error: ${data.error}`);
            return;
        }
        
        if (data.status === 'already_exists') {
            alert('This attraction is already in your itinerary.');
            return;
        }
        
        // Add new item to UI
        const itineraryList = document.getElementById('itinerary-list');
        const emptyMessage = document.querySelector('.empty-message');
        
        if (emptyMessage) emptyMessage.remove();
        
        if (!itineraryList) {
            // Create the list if it doesn't exist
            const itinerarySection = document.querySelector('.itinerary-section');
            const newList = document.createElement('ul');
            newList.id = 'itinerary-list';
            newList.className = 'itinerary-items';
            itinerarySection.appendChild(newList);
        }
        
        // Create new itinerary item element
        const newItem = document.createElement('li');
        newItem.id = `itinerary-item-${data.item_id}`;
        newItem.dataset.id = data.item_id;
        newItem.className = 'itinerary-item';
        
        newItem.innerHTML = `
            <div class="item-content">
                <h4>${place.name}</h4>
                <p>${place.vicinity || ''}</p>
                <div class="item-actions">
                    <button class="btn-small view-on-map" data-lat="${place.geometry.location.lat}" data-lng="${place.geometry.location.lng}">View on Map</button>
                    <button class="btn-small remove-item" data-id="${data.item_id}">Remove</button>
                </div>
            </div>
        `;
        
        // Add to DOM with initial opacity 0
        newItem.style.opacity = "0";
        document.getElementById('itinerary-list').appendChild(newItem);
        
        // Add marker for the new itinerary item
        const marker = addMarkerToMap({
            position: {
                lat: place.geometry.location.lat,
                lng: place.geometry.location.lng
            },
            title: place.name,
            address: place.vicinity || '',
            id: data.item_id,
            isItineraryItem: true
        });
        
        // Update the existing marker to be an itinerary marker
        const existingMarker = markers.find(m => 
            m.place_id === place.place_id && !m.isItineraryItem
        );
        
        if (existingMarker) {
            existingMarker.setMap(null);
            markers = markers.filter(m => m !== existingMarker);
        }
        
        // Set up event handlers for the new item
        setupItemHandlers(newItem);
        
        // Fade in the new item
        setTimeout(() => {
            newItem.style.transition = "opacity 0.5s ease, background-color 1s";
            newItem.style.opacity = "1";
            newItem.style.backgroundColor = '#e6f7ff';
            
            // Reset background color after highlight
            setTimeout(() => {
                newItem.style.backgroundColor = '';
            }, 1000);
        }, 10);
    })
    .catch(error => {
        alert('Error adding to itinerary: ' + error.message);
    });
}

function removeFromItinerary(itemId, itemElement) {
    // Remove confirmation dialog to prevent UI disruption
    
    // Apply a fade-out effect before removal
    if (itemElement) {
        itemElement.style.transition = "opacity 0.3s ease";
        itemElement.style.opacity = "0";
    }
    
    fetch(`/api/itinerary/remove/${itemId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(`Error: ${data.error}`);
            // Restore opacity if error occurs
            if (itemElement) {
                itemElement.style.opacity = "1";
            }
            return;
        }
        
        // Remove the item from the UI after animation completes
        setTimeout(() => {
            const itemElement = document.getElementById(`itinerary-item-${itemId}`);
            if (itemElement) itemElement.remove();
            
            // Remove the marker from the map
            const marker = markers.find(m => m.id === parseInt(itemId));
            if (marker) {
                marker.setMap(null);
                markers = markers.filter(m => m !== marker);
            }
            
            // Check if itinerary is now empty
            const itineraryList = document.getElementById('itinerary-list');
            if (itineraryList && itineraryList.children.length === 0) {
                itineraryList.remove();
                
                const itinerarySection = document.querySelector('.itinerary-section');
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'empty-message';
                emptyMessage.textContent = 'No attractions added to your itinerary yet. Search below to find attractions.';
                itinerarySection.appendChild(emptyMessage);
            }
        }, 300); // Match this with the transition duration
    })
    .catch(error => {
        console.error('Error removing from itinerary:', error);
        // Restore opacity if error occurs
        if (itemElement) {
            itemElement.style.opacity = "1";
        }
    });
}

function getCsrfToken() {
    return document.querySelector('input[name="csrfmiddlewaretoken"]').value;
}

// New helper function to set up event handlers for a single item
function setupItemHandlers(itemElement) {
    const viewButton = itemElement.querySelector('.view-on-map');
    if (viewButton) {
        viewButton.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            
            map.setCenter({lat, lng});
            map.setZoom(16);
            
            // Find and activate the corresponding marker
            const marker = markers.find(m => 
                m.id === parseInt(this.closest('.itinerary-item').dataset.id)
            );
            
            if (marker) {
                google.maps.event.trigger(marker, 'click');
            }
        });
    }
    
    const removeButton = itemElement.querySelector('.remove-item');
    if (removeButton) {
        removeButton.addEventListener('click', function() {
            const itemId = this.dataset.id;
            removeFromItinerary(itemId, this.closest('.itinerary-item'));
        });
    }
}

// Add hidden CSRF token for AJAX requests
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';
    document.body.appendChild(csrfToken);
});
</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&libraries=places&callback=initMap">
</script>
{% endblock %}