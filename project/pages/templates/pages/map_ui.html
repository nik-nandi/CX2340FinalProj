{% extends 'pages/base.html' %}

{% block content %}
<div class="map-container">
    <h2>Plan Your Trip</h2>
    
    <div class="map-interface">
        <div id="map" style="height: 500px; width: 100%;"></div>
        
        <div class="map-controls">
            <div class="trip-area-section">
                <h3>Trip Areas</h3>
                {% if trip_areas %}
                    <ul class="trip-areas-list">
                        {% for area in trip_areas %}
                            <li>
                                <h4>{{ area.name }}</h4>
                                <p>{{ area.description }}</p>
                                <button class="btn view-area" data-lat="{{ area.latitude }}" data-lng="{{ area.longitude }}" data-radius="{{ area.radius }}">View on Map</button>
                                <button class="btn add-location" data-area-id="{{ area.id }}">Add Location</button>
                                
                                {% if area.locations.all %}
                                    <div class="locations-list">
                                        <h5>Selected Locations</h5>
                                        <ul>
                                            {% for location in area.locations.all %}
                                                <li>
                                                    <strong>{{ location.name }}</strong>
                                                    <p>{{ location.address }}</p>
                                                    <button class="btn view-location" data-lat="{{ location.latitude }}" data-lng="{{ location.longitude }}">View</button>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No trip areas created yet. Use the map to create your first trip area.</p>
                {% endif %}
            </div>
            
            <div class="create-trip-area">
                <h3>Create a New Trip Area</h3>
                <form id="trip-area-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="create_trip_area" value="1">
                    <div class="form-group">
                        <label for="name">Name:</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description:</label>
                        <textarea id="description" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="radius">Radius (km):</label>
                        <input type="number" id="radius" name="radius" value="10" min="1" max="100">
                    </div>
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <p>Click on the map to set the center of your trip area.</p>
                    <button type="submit" class="btn" disabled id="submit-trip-area">Create Trip Area</button>
                </form>
            </div>
            
            <div class="create-location" style="display: none;">
                <h3>Add Location to <span id="selected-area-name"></span></h3>
                <form id="location-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="create_trip_location" value="1">
                    <input type="hidden" id="trip_area_id" name="trip_area_id">
                    <div class="form-group">
                        <label for="location_name">Location Name:</label>
                        <input type="text" id="location_name" name="location_name" required>
                    </div>
                    <div class="form-group">
                        <label for="location_description">Description:</label>
                        <textarea id="location_description" name="location_description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="location_address">Address:</label>
                        <input type="text" id="location_address" name="location_address" readonly>
                    </div>
                    <input type="hidden" id="location_latitude" name="location_latitude">
                    <input type="hidden" id="location_longitude" name="location_longitude">
                    <p>Click on the map within the selected trip area to add a specific location.</p>
                    <button type="submit" class="btn" disabled id="submit-location">Add Location</button>
                    <button type="button" class="btn cancel-location">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let markers = [];
let currentCircle = null;
let geocoder;
let selectedAreaId = null;

function initMap() {
    // Initialize map centered on a default location (e.g., Atlanta, GA)
    const defaultLocation = { lat: 33.7490, lng: -84.3880 };
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: defaultLocation,
        styles: [
            // Custom map styling for a cleaner look
            {
                "featureType": "administrative",
                "elementType": "geometry",
                "stylers": [{ "visibility": "off" }]
            },
            {
                "featureType": "poi",
                "stylers": [{ "visibility": "off" }]
            },
            {
                "featureType": "road",
                "elementType": "labels.icon",
                "stylers": [{ "visibility": "off" }]
            },
            {
                "featureType": "transit",
                "stylers": [{ "visibility": "off" }]
            }
        ]
    });
    
    geocoder = new google.maps.Geocoder();
    
    // Add click event for setting trip area or location
    map.addListener("click", (e) => {
        const clickedPosition = e.latLng;
        
        if (selectedAreaId) {
            // We're adding a location to an existing trip area
            handleLocationSelection(clickedPosition);
        } else {
            // We're creating a new trip area
            handleTripAreaSelection(clickedPosition);
        }
    });
    
    // Initialize view-area buttons
    document.querySelectorAll('.view-area').forEach(btn => {
        btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            const radius = parseFloat(this.dataset.radius);
            const center = new google.maps.LatLng(lat, lng);
            
            map.setCenter(center);
            map.setZoom(12);
            
            // Clear existing circle if any
            if (currentCircle) {
                currentCircle.setMap(null);
            }
            
            // Draw circle to represent the trip area
            currentCircle = new google.maps.Circle({
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.35,
                map,
                center: center,
                radius: radius * 1000  // Convert km to meters
            });
        });
    });
    
    // Initialize add-location buttons
    document.querySelectorAll('.add-location').forEach(btn => {
        btn.addEventListener('click', function() {
            selectedAreaId = this.dataset.areaId;
            const areaName = this.closest('li').querySelector('h4').textContent;
            
            document.getElementById('trip_area_id').value = selectedAreaId;
            document.getElementById('selected-area-name').textContent = areaName;
            document.querySelector('.create-location').style.display = 'block';
            document.querySelector('.create-trip-area').style.display = 'none';
        });
    });
    
    // Initialize view-location buttons
    document.querySelectorAll('.view-location').forEach(btn => {
        btn.addEventListener('click', function() {
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);
            const center = new google.maps.LatLng(lat, lng);
            
            map.setCenter(center);
            map.setZoom(16);
        });
    });
    
    // Cancel location selection
    document.querySelector('.cancel-location').addEventListener('click', function() {
        selectedAreaId = null;
        document.querySelector('.create-location').style.display = 'none';
        document.querySelector('.create-trip-area').style.display = 'block';
        clearMarkers();
    });
}

function handleTripAreaSelection(position) {
    clearMarkers();
    
    // Add marker at clicked position
    const marker = new google.maps.Marker({
        position: position,
        map: map,
        animation: google.maps.Animation.DROP
    });
    markers.push(marker);
    
    // Update form fields
    document.getElementById('latitude').value = position.lat();
    document.getElementById('longitude').value = position.lng();
    document.getElementById('submit-trip-area').disabled = false;
    
    // Draw preview circle
    const radius = parseInt(document.getElementById('radius').value);
    if (currentCircle) {
        currentCircle.setMap(null);
    }
    currentCircle = new google.maps.Circle({
        strokeColor: "#FF0000",
        strokeOpacity: 0.8,
        strokeWeight: 2,
        fillColor: "#FF0000",
        fillOpacity: 0.35,
        map,
        center: position,
        radius: radius * 1000  // Convert km to meters
    });
}

function handleLocationSelection(position) {
    clearMarkers();
    
    // Add marker at clicked position
    const marker = new google.maps.Marker({
        position: position,
        map: map,
        animation: google.maps.Animation.DROP
    });
    markers.push(marker);
    
    // Update form fields
    document.getElementById('location_latitude').value = position.lat();
    document.getElementById('location_longitude').value = position.lng();
    
    // Get address using geocoder
    geocoder.geocode({ location: position }, (results, status) => {
        if (status === "OK" && results[0]) {
            document.getElementById('location_address').value = results[0].formatted_address;
            document.getElementById('submit-location').disabled = false;
        } else {
            document.getElementById('location_address').value = "Address not found";
        }
    });
}

function clearMarkers() {
    for (let marker of markers) {
        marker.setMap(null);
    }
    markers = [];
}

// Update radius preview when the input changes
document.getElementById('radius').addEventListener('change', function() {
    if (currentCircle) {
        const value = parseInt(this.value);
        currentCircle.setRadius(value * 1000); // Convert km to meters
    }
});
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
</script>
{% endblock %}
